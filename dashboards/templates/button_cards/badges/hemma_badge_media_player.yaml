# Media Player Badge
hemma_badge_media_player:
  template: [hemma_badge_base]
  show_icon: false
  show_entity_picture: true
  show_name: true
  show_state: false
  show_label: false

  variables:
    enabled: true
    entity: null
    pause_timeout_minutes: 5

  entity: '[[[ return variables.entity || entity?.entity_id ]]]'

  triggers_update:
    - '[[[ return variables.entity || entity?.entity_id; ]]]'

  styles:
    card:
      - padding: 0 8px 0 8px !important
      - background: rgba(0,0,0,0.18) !important
      - -webkit-backdrop-filter: blur(14px) saturate(1.2) !important
      - backdrop-filter: blur(14px) saturate(1.2) !important
      - border-radius: 9999px !important
      - overflow: hidden !important
      - width: fit-content !important
      - max-width: min(var(--badge-media-max-width-current, 640px), calc(100vw - 30px)) !important
      - min-height: calc(var(--badge-min-height-current, var(--badge-min-height, 50px)) + 3px) !important
      - align-items: center !important
      - justify-content: flex-start !important
      - text-align: left !important
      - gap: 6px !important
      - isolation: isolate
      - margin: 0 0 var(--badge-media-row-gap, 14px) 0 !important
      - justify-self: start !important
      - align-self: start !important
      - place-self: start !important

      - display: >
          [[[
            const enabled = (v) => {
              if (v === undefined || v === null) return true;
              if (typeof v === 'boolean') return v;
              if (typeof v === 'number') return v !== 0;
              const s = String(v).trim().toLowerCase();
              return !['false','0','no','off','disabled'].includes(s);
            };

            if (!enabled(variables.enabled)) return 'none';

            const eid = variables.entity || entity?.entity_id;
            const s = eid ? states[eid] : null;
            if (!s) return 'none';

            const st = String(s.state || '');
            if (['unavailable','unknown','off','standby'].includes(st)) return 'none';

            const a = s.attributes || {};
            const title  = String(a.media_title || '').trim();
            const artist = String(a.media_artist || a.artist || a.media_album_artist || '').trim();
            const hasContent = !!(title || artist);

            if (['playing','buffering'].includes(st)) return hasContent ? 'inline-grid' : 'none';

            if (st === 'paused') {
              if (!hasContent) return 'none';
              const timeout = Number(variables.pause_timeout_minutes ?? 5);
              if (timeout <= 0) return 'inline-grid';
              return ((new Date() - new Date(s.last_changed)) / 60000) > timeout ? 'none' : 'inline-grid';
            }

            if (['idle','on'].includes(st)) return hasContent ? 'inline-grid' : 'none';

            return 'none';
          ]]]

      - --bg-url: >
          [[[
            const cacheKey = '_hemmaMpBgUrl';
            const eid = variables.entity || entity?.entity_id;
            const a = eid ? (states[eid]?.attributes || {}) : {};

            const raw =
              a.entity_picture ||
              a.media_image_url ||
              a.media_album_cover_url ||
              a.image_url;

            if (raw) {
              const url = String(raw).startsWith('/') ? `${location.origin}${raw}` : raw;
              const wrapped = `url("${url}")`;
              this[cacheKey] = wrapped;
              return wrapped;
            }
            return this[cacheKey] || 'none';
          ]]]

    grid:
      - grid-template-areas: '"i info controls"'
      - grid-template-columns: min-content minmax(0, 1fr) min-content
      - column-gap: 11px
      - align-items: center

    entity_picture:
      - grid-area: i
      - width: var(--badge-icon-size-current, var(--badge-icon-size, 36px)) !important
      - height: var(--badge-icon-size-current, var(--badge-icon-size, 36px)) !important
      - min-width: var(--badge-icon-size-current, var(--badge-icon-size, 36px)) !important
      - min-height: var(--badge-icon-size-current, var(--badge-icon-size, 36px)) !important
      - border-radius: 9999px !important
      - object-fit: cover !important
      - box-shadow: inset 0 0 0 1px rgba(255,255,255,0.14) !important
      - z-index: 6

    name:
      - grid-area: info
      - padding: 0 7px 0 0 !important
      - margin-top: 2px !important
      - min-width: 0
      - max-width: 100%
      - overflow: hidden !important
      - text-align: left !important
      - justify-self: start
      - z-index: 6

    custom_fields:
      controls:
        - grid-area: controls
        - z-index: 6

  entity_picture: >
    [[[
      const eid = variables.entity || entity?.entity_id;
      const a = eid ? (states[eid]?.attributes || {}) : {};
      const raw =
        a.entity_picture ||
        a.media_image_url ||
        a.media_album_cover_url ||
        a.image_url;

      if (raw) return String(raw).startsWith('/') ? `${location.origin}${raw}` : raw;

      const appName = String(a.app_name || a.source || '').toLowerCase();
      const appId = String(a.app_id || '').toLowerCase();
      if (appName.includes('youtube') || appId.includes('youtube'))
        return '/local/hemma/icons/youtube.png';

      return null;
    ]]]

  name: >
    [[[
      const eid = variables.entity || entity?.entity_id;
      const a = eid ? (states[eid]?.attributes || {}) : {};
      const title  = String(a.media_title || '').trim();
      const artist = String(a.media_artist || a.artist || a.media_album_artist || '').trim();

      const esc = (s) => String(s ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');

      return `
        <div class="mp-wrap">
          <div class="mp-title">${esc(title || a.friendly_name || 'Media')}</div>
          <div class="mp-sub">${esc(artist || '')}</div>
        </div>
      `;
    ]]]

  tap_action:
    action: more-info
    entity: '[[[ return variables.entity || entity?.entity_id ]]]'

  hold_action:
    action: none

  custom_fields:
    controls:
      card:
        type: custom:button-card
        show_icon: false
        show_name: false
        show_state: false
        styles:
          card:
            - background: transparent
            - box-shadow: none
            - padding: 0
            - margin: 0
            - border-radius: 9999px
            - --ha-ripple-color: rgba(0,0,0,0) !important
            - --ha-ripple-hover-color: rgba(0,0,0,0) !important
            - --ha-ripple-pressed-color: rgba(0,0,0,0) !important
            - --mdc-ripple-color: rgba(0,0,0,0) !important
          grid:
            - grid-template-areas: '"play next"'
            - grid-template-columns: min-content min-content
            - column-gap: 8px
            - align-items: center

        custom_fields:
          play:
            card:
              type: custom:button-card
              entity: '[[[ return variables.entity ]]]'
              icon: >
                [[[
                  const eid = variables.entity;
                  const st = eid ? String(states[eid]?.state || '') : '';
                  return (st === 'playing') ? 'mdi:pause' : 'mdi:play';
                ]]]
              show_icon: true
              show_name: false
              styles:
                card:
                  - width: var(--badge-icon-size-current, 36px)
                  - height: var(--badge-icon-size-current, 36px)
                  - border-radius: 9999px
                  - background: rgba(255,255,255,0.10)
                  - box-shadow: none
                  - padding: 6px
                  - transform: none !important
                  - --ha-ripple-color: rgba(0,0,0,0) !important
                  - --ha-ripple-hover-color: rgba(0,0,0,0) !important
                  - --ha-ripple-pressed-color: rgba(0,0,0,0) !important
                  - --mdc-ripple-color: rgba(0,0,0,0) !important
                icon:
                  - color: rgba(255,255,255,0.92)
                  - width: var(--badge-btn-size-current, 22px)
                  - height: var(--badge-btn-size-current, 22px)
              tap_action:
                action: call-service
                service: media_player.media_play_pause
                service_data:
                  entity_id: '[[[ return variables.entity ]]]'
              extra_styles: |
                ha-card{
                  transition: background-color .22s ease,
                              box-shadow .24s ease,
                              transform .14s ease,
                              filter .18s ease !important;
                  transform: none !important;
                }
                ha-card:hover{ background: rgba(255,255,255,0.14) !important; }
                ha-card:active{
                  background: rgba(255,255,255,0.18) !important;
                  filter: brightness(1.06) !important;
                  transform: none !important;
                }

          next:
            card:
              type: custom:button-card
              icon: mdi:skip-next
              show_icon: true
              show_name: false
              styles:
                card:
                  - width: var(--badge-icon-size-current, 36px)
                  - height: var(--badge-icon-size-current, 36px)
                  - border-radius: 9999px
                  - background: rgba(255,255,255,0.10)
                  - padding: 6px
                  - transform: none !important
                  - --ha-ripple-color: rgba(0,0,0,0) !important
                  - --ha-ripple-hover-color: rgba(0,0,0,0) !important
                  - --ha-ripple-pressed-color: rgba(0,0,0,0) !important
                  - --mdc-ripple-color: rgba(0,0,0,0) !important
                icon:
                  - color: rgba(255,255,255,0.92)
                  - width: var(--badge-btn-size-current, 22px)
                  - height: var(--badge-btn-size-current, 22px)
              tap_action:
                action: call-service
                service: media_player.media_next_track
                service_data:
                  entity_id: '[[[ return variables.entity ]]]'
              extra_styles: |
                ha-card{
                  transition: background-color .22s ease,
                              box-shadow .24s ease,
                              transform .14s ease,
                              filter .18s ease !important;
                  transform: none !important;
                }
                ha-card:hover{ background: rgba(255,255,255,0.14) !important; }
                ha-card:active{
                  background: rgba(255,255,255,0.18) !important;
                  filter: brightness(1.06) !important;
                  transform: none !important;
                }

  extra_styles: |
    :host{
      --hemma-mp-title: var(--badge-font-size-current, var(--badge-font-size, 15px));
      --hemma-mp-sub: calc(var(--hemma-mp-title) - 2px);

      display: inline-block !important;
      width: fit-content !important;
      max-width: 100% !important;
      justify-self: start !important;
      align-self: start !important;
      pointer-events: none !important;
    }

    :host ha-card{
      pointer-events: auto !important;
      cursor: pointer !important;
    }

    :host ha-card::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius: inherit;
      background: var(--bg-url);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: blur(26px) saturate(1.4);
      opacity: .45;
      transform: scale(1.25);
      z-index: 0;
      transition: opacity .22s ease, filter .18s ease !important;
    }

    :host ha-card::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius: inherit;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.18),
        0 0 0 1px rgba(255,255,255,0.14);
      z-index: 1;
      opacity: 1 !important;
    }

    #container{
      height: auto !important;
      min-height: 0 !important;
      align-items: center !important;
      align-content: center !important;
    }

    .mp-wrap{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:2px;
      min-width:0;
      max-width:100%;
      overflow:hidden;
      padding-top: 0 !important;
      padding-bottom: 2px !important;
      line-height: normal !important;
    }

    .mp-title{
      font-size: var(--hemma-mp-title);
      font-weight: 700;
      line-height: 1.1;
      color: rgba(255,255,255,0.96);
      text-shadow: 0 0 3px rgba(0,0,0,0.25);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
      text-align:left;
    }

    .mp-sub{
      font-size: var(--hemma-mp-sub);
      font-weight: 500;
      line-height: 1.14;
      opacity: .82;
      color: rgba(255,255,255,0.90);
      text-shadow: 0 0 3px rgba(0,0,0,0.20);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
      text-align:left;
    }

    #img-cell, #name, #custom_fields{
      position: relative;
      z-index: 6;
    }
