# Room
hemma_room:
  class: "hemma-room"
  template:
    - hemma_default
    - hemma_shared

  triggers_update:
    - '[[[ return variables.motion_sensor ]]]'
    - '[[[ return variables.temp_sensor ]]]'
    - '[[[ return variables.quality_sensor ]]]'
    - '[[[ return variables.humidity_sensor ]]]'
    - '[[[ return variables.presence_entity_1 ]]]'
    - '[[[ return variables.presence_entity_2 ]]]'
    - '[[[ return variables.media_player_1 ]]]'
    - '[[[ return variables.media_player_2 ]]]'
    - '[[[ return variables.media_player_3 ]]]'
    - '[[[ return variables.media_player_4 ]]]'
    - '[[[ return variables.image ]]]'
    - '[[[ return variables.image_night ]]]'
    - '[[[ return variables.image_position ]]]'
    - '[[[ return variables.show_weather ]]]'
    - '[[[ return variables.weather_entity ]]]'
    - '[[[ return variables.weather_temp_sensor ]]]'
    - input_boolean.hemma_mobile_navigation

  variables:
    image:
    image_night:
    image_position:

    show_quality: false
    quality_sensor:

    show_humidity: false
    humidity_sensor:

    show_temp: false
    temp_sensor:

    show_motion: false
    motion_sensor:

    show_presence: false
    presence_entity_1:
    presence_entity_2:

    show_media_badge: false
    pause_timeout_minutes: 5

    show_media_player_1: false
    media_player_1:

    show_media_player_2: false
    media_player_2:

    show_media_player_3: false
    media_player_3:

    show_media_player_4: false
    media_player_4:

    show_weather: false
    weather_mode:
    weather_entity:
    weather_temp_sensor:

  tap_action: { action: none }
  hold_action: { action: none }
  double_tap_action: { action: none }

  styles:
    card:
      - height: 100svh
      - padding-top: >
          [[[
            const mm = (q) => (window.matchMedia ? window.matchMedia(q).matches : false);
            const isPhonePortrait =
              (mm('(pointer: coarse)') || mm('(hover: none)')) &&
              mm('(max-width: 767px)') &&
              mm('(orientation: portrait)');

            const base = 'var(--hero-top)';
            return isPhonePortrait ? `calc(${base} - 20px)` : base;
          ]]]
      - padding-left: var(--hero-gutter)
      - padding-right: var(--hero-gutter)
      - padding-bottom: calc(130px + env(safe-area-inset-bottom))
      - box-shadow: none !important
      - transform: translateZ(0)
      - will-change: transform
      - --hero-img-filter: blur(4px)
      - --hero-img-scale: 1.08
      - --hero-img: >
          [[[
            const base = variables.image || 'default';
            const isDark = !!(hass?.themes?.darkMode);
            const picked = isDark ? (variables.image_night || `${base}-night`) : base;
            const url = `/local/hemma/rooms/${picked}.jpg`;
            return `url("${url}")`;
          ]]]
      - --hero-img-pos: >
          [[[
            return variables.image_position || 'center center';
          ]]]
      - --hemma-time-right: >
          [[[
            const w = window?.innerWidth || 1024;
            const h = window?.innerHeight || 800;
            const isTablet = (w >= 768 && w <= 1249 && h > 500);
            return isTablet ? 'calc(var(--hero-gutter) - 20px)' : 'var(--hemma-nav-margin-current, 4vw)';
          ]]]

    name:
      - grid-area: n
      - color: var(--primary-text-color)
      - opacity: 0.9
      - font-size: var(--hero-room-name-size-current, clamp(48px, 6vw + 12px, 100px))
      - letter-spacing: var(--hero-room-name-letter-spacing-current, -2px)
      - font-weight: 700
      - justify-self: start
      - padding-left: 0
      - line-height: var(--hero-room-name-line-height-current, 1.2)
      - margin-left: var(--hero-room-name-margin-left-current, 0px)
      - overflow: visible

    grid: []  # Inherits from hemma_shared

    custom_fields:
      motion_detection:
        - display: >
            [[[
              return variables.show_motion && variables.motion_sensor ? 'block' : 'none';
            ]]]
        - position: fixed
        - right: 0
        - left: 0
        - bottom: 0
        - transform: >
            [[[
              return states[variables.motion_sensor]?.state === 'on'
                ? 'translateY(0)'
                : 'translateY(100%)';
            ]]]
        - transition: transform 0.5s
        - padding: 14px
        - color: white
        - font-size: 13px
        - text-transform: uppercase
        - letter-spacing: 2px
        - font-weight: 700
        - background: rgba(255,255,255,0.08)
        - backdrop-filter: blur(10px)
        - z-index: 999

      temperature:
        - grid-area: temperature
        - display: >
            [[[
              const mm = (q) => (window.matchMedia ? window.matchMedia(q).matches : false);
              const isPhonePortrait =
                (mm('(pointer: coarse)') || mm('(hover: none)')) &&
                mm('(max-width: 767px)') &&
                mm('(orientation: portrait)');
              return isPhonePortrait ? 'none' : 'flex';
            ]]]
        - align-items: center
        - height: var(--hero-temp-reserve, 22px)
        - overflow: hidden
        - pointer-events: auto
        - cursor: pointer
        - position: relative
        - z-index: 5
        - color: var(--primary-text-color)
        - justify-self: start
        - margin: 0
        - padding-left: 0
        - background: transparent !important
        - background-color: transparent !important
        - margin-left: >
            calc(
              var(--hero-room-name-margin-left-current, 0px) +
              var(--hemma-header-temp-nudge, 0px))
        - font-size: var(--hero-temp-font-size, var(--hero-temp-font-size-desktop, 16px))

      time:
        - position: fixed
        - top: >
            [[[
              const w = window?.innerWidth || 1024;
              const h = window?.innerHeight || 800;

              const isMobile = (w <= 767 || h <= 500);
              const isTablet = (w >= 768 && w <= 1249 && h > 500);

              const nudge =
                isMobile ? 'var(--hemma-time-nudge-mobile, 8px)' :
                isTablet ? 'var(--hemma-time-nudge-tablet, 36px)' :
                '0px';

              return `calc(env(safe-area-inset-top, 0px) + var(--hemma-nav-top-current, 46px) - ${nudge})`;
            ]]]
        - right: >
            [[[
              return `var(--hemma-time-right, var(--hemma-nav-margin-current, 4vw))`;
            ]]]
        - z-index: 10
        - pointer-events: auto
        - "--mdc-ripple-press-opacity": 0
        - "-webkit-tap-highlight-color": transparent
        - display: >
            [[[
              const navOpen = states['input_boolean.hemma_mobile_navigation']?.state === 'on';
              const mm = (q) => (window.matchMedia ? window.matchMedia(q).matches : false);
              const isTouch = mm('(pointer: coarse)') || mm('(hover: none)');
              const w = window?.innerWidth || 1024;
              const h = window?.innerHeight || 800;
              const isTablet = (w >= 768 && w <= 1249 && h > 500);
              return (!navOpen && isTouch && isTablet) ? 'block' : 'none';
            ]]]

      weather:
        - grid-area: weather
        - display: >
            [[[
              const mm = (q) => (window.matchMedia ? window.matchMedia(q).matches : false);
              const isPhonePortrait =
                (mm('(pointer: coarse)') || mm('(hover: none)')) &&
                mm('(max-width: 767px)') &&
                mm('(orientation: portrait)');
              const mode = String(variables.weather_mode || '').toLowerCase();
              const isOutdoor = (mode === 'outdoor');
              const isRoom = (mode === 'room');
              const hasOutdoorData = isOutdoor && !!(variables.weather_entity || variables.weather_temp_sensor);
              const hasRoomData = isRoom && !!variables.temp_sensor;
              const ok = !!variables.show_weather && (hasOutdoorData || hasRoomData);
              return (isPhonePortrait && ok) ? 'block' : 'none';
            ]]]
        - position: absolute
        - top: >
            calc(var(--hero-top) - 20px +
            (var(--hero-room-name-size-current, 48px) * var(--hero-room-name-line-height-current, 1.2)) - 15px)
        - left: var(--hero-gutter, var(--page-gutter-mobile, 11px))
        - right: var(--hero-gutter, var(--page-gutter-mobile, 11px))
        - z-index: 10
        - text-align: right
        - align-self: start
        - justify-self: end
        - margin: 0
        - width: auto
        - max-width: none
        - overflow: visible
        - pointer-events: auto

      badges:
        - grid-area: badges
        - justify-self: start !important
        - align-self: start !important
        - place-self: start !important
        - text-align: left !important
        - margin-left: >
            calc(
              var(--hero-room-name-margin-left-current, 0px) +
              var(--hemma-header-badge-nudge, 0px)) !important
        - margin-right: auto !important
        - width: max-content
        - max-width: 100%
        - margin-top: 0
        - margin-bottom: 0
        - padding-left: 0
        - pointer-events: auto
        - height: auto !important
        - display: >
            [[[
              return (states['input_boolean.hemma_mobile_navigation']?.state === 'on')
                ? 'none'
                : 'block';
            ]]]

      badges_media:
        - grid-area: badges_media
        - justify-self: start !important
        - align-self: start !important
        - place-self: start !important
        - text-align: left !important
        - margin-top: 0px !important
        - margin-right: auto !important
        - margin-left: >
            calc(
              var(--hero-room-name-margin-left-current, 0px) +
              var(--hemma-header-badge-nudge, 0px)
            ) !important
        - padding-left: 0 !important
        - padding-top: 0px !important
        - padding-bottom: 0px !important
        - height: auto !important
        - min-height: 0 !important
        - width: max-content
        - max-width: 100%
        - pointer-events: auto
        - display: >
            [[[
              const navOpen = states['input_boolean.hemma_mobile_navigation']?.state === 'on';
              if (navOpen) return 'none';

              const enabled = (v) => {
                if (v === undefined || v === null) return false;
                if (typeof v === 'boolean') return v;
                if (typeof v === 'number')  return v !== 0;
                const s = String(v).trim().toLowerCase();
                if (['false','0','no','off','disabled'].includes(s)) return false;
                if (['true','1','yes','on','enabled'].includes(s))   return true;
                return !!s;
              };

              const isMediaActive = (eid) => {
                if (!eid) return false;

                const s  = states[eid];
                const st = String(s?.state || '');
                const a  = s?.attributes || {};

                if (!s || ['unavailable', 'unknown'].includes(st)) return false;
                if (['off', 'standby'].includes(st)) return false;

                const title   = String(a.media_title || '').trim();
                const artist  = String(a.media_artist || a.artist || a.media_album_artist || '').trim();
                const hasContent = !!(title || artist);

                if (st === 'playing' || st === 'buffering') return true;
                if (st === 'paused') return hasContent;
                if (st === 'idle' || st === 'on') return hasContent;

                return false;
              };

              const anyNowPlaying =
                (enabled(variables.show_media_player_1) && isMediaActive(variables.media_player_1)) ||
                (enabled(variables.show_media_player_2) && isMediaActive(variables.media_player_2)) ||
                (enabled(variables.show_media_player_3) && isMediaActive(variables.media_player_3)) ||
                (enabled(variables.show_media_player_4) && isMediaActive(variables.media_player_4));

              const anyPsn =
                (enabled(variables.show_psn_1) && states[variables.psn_1]) ||
                (enabled(variables.show_psn_2) && states[variables.psn_2]);

              const anyPlex =
                enabled(variables.show_media_plex) && states[variables.media_plex_binary]?.state === 'on';

              return (anyNowPlaying || anyPsn || anyPlex) ? 'block' : 'none';
            ]]]

      navigation:
        - position: fixed
        - top: 46px
        - left: 0
        - right: 0
        - z-index: 50
        - overflow: visible
        - pointer-events: auto
        - "--mdc-ripple-press-opacity": 0
        - "-webkit-tap-highlight-color": transparent
        - filter: none

      menu:
        - position: fixed
        - top: 8px
        - left: >
            [[[
              const w = window?.innerWidth || 1024;
              const h = window?.innerHeight || 800;

              if (w <= 767 || h <= 500) {
                return 'calc(var(--hero-gutter) - 11px)';
              }

              return 'calc(var(--hero-gutter) - 6px)';
            ]]]
        - width: 40px
        - height: 40px
        - z-index: 10
        - pointer-events: auto
        - cursor: pointer

      preload:
        - display: none
        - width: 0
        - height: 0
        - opacity: 0
        - overflow: hidden
        - position: fixed
        - pointer-events: none

  custom_fields:
    menu:
      card:
        type: custom:button-card
        template: hemma_menu_icon

    navigation:
      card: !include /config/dashboards/templates/includes/hemma_navigation.yaml

    preload: |
      [[[
        const base = variables.image || 'default';
        const night = variables.image_night || `${base}-night`;
        const dayUrl = `/local/hemma/rooms/${base}.jpg`;
        const nightUrl = `/local/hemma/rooms/${night}.jpg`;

        return `
          <img src="${dayUrl}" alt="" />
          <img src="${nightUrl}" alt="" />
        `;
      ]]]

    # Temperature
    temperature:
      card:
        type: custom:button-card
        template: hemma_temperature
        variables:
          weather_mode: '[[[ return variables.weather_mode ]]]'
          show_weather: '[[[ return variables.show_weather ]]]'
          weather_entity: '[[[ return variables.weather_entity ]]]'
          weather_temp_sensor: '[[[ return variables.weather_temp_sensor ]]]'
          show_temp: '[[[ return variables.show_temp ]]]'
          temp_sensor: '[[[ return variables.temp_sensor ]]]'
    weather:
      card:
        type: custom:button-card
        template: hemma_weather
        entity: '[[[ return variables.weather_entity ]]]'
        variables:
          weather_mode: '[[[ return variables.weather_mode ]]]'
          weather_temp_sensor: '[[[ return variables.weather_temp_sensor ]]]'
          temp_sensor: '[[[ return variables.temp_sensor ]]]'

    time:
      card:
        type: custom:button-card
        template: hemma_time

    badges:
      card:
        type: custom:layout-card
        layout_type: custom:grid-layout

        layout:
          grid-auto-flow: column
          grid-auto-columns: max-content
          grid-template-columns: none
          justify-content: start
          justify-items: start
          align-items: center
          grid-column-gap: var(--badge-gap-current, var(--badge-gap, 10px))

        cards:
          - type: custom:button-card
            template: hemma_badge_presence
            entity: '[[[ return variables.presence_entity_1 ]]]'
            variables:
              enabled: '[[[ return variables.show_presence ]]]'

          - type: custom:button-card
            template: hemma_badge_presence
            entity: '[[[ return variables.presence_entity_2 ]]]'
            variables:
              enabled: '[[[ return variables.show_presence ]]]'

          - type: custom:button-card
            template: hemma_badge_air_quality
            entity: '[[[ return variables.quality_sensor ]]]'
            variables:
              enabled: '[[[ return variables.show_quality ]]]'

          - type: custom:button-card
            template: hemma_badge_humidity
            entity: '[[[ return variables.humidity_sensor ]]]'
            variables:
              enabled: '[[[ return variables.show_humidity ]]]'

    badges_media:
      card:
        type: custom:layout-card
        layout_type: custom:grid-layout

        layout:
          grid-template-columns: 1fr
          grid-auto-flow: row
          grid-auto-rows: min-content
          justify-items: start
          justify-content: start
          align-items: start
          align-content: start
          grid-row-gap: 0px

        cards:

          # Media Player 1
          - type: custom:button-card
            template: hemma_badge_media_player
            variables:
              enabled: '[[[ return variables.show_media_player_1 ]]]'
              entity: '[[[ return variables.media_player_1 ]]]'
              pause_timeout_minutes: '[[[ return variables.pause_timeout_minutes ]]]'

          # Media Player 2
          - type: custom:button-card
            template: hemma_badge_media_player
            variables:
              enabled: '[[[ return variables.show_media_player_2 ]]]'
              entity: '[[[ return variables.media_player_2 ]]]'
              pause_timeout_minutes: '[[[ return variables.pause_timeout_minutes ]]]'

          # Media Player 3
          - type: custom:button-card
            template: hemma_badge_media_player
            variables:
              enabled: '[[[ return variables.show_media_player_3 ]]]'
              entity: '[[[ return variables.media_player_3 ]]]'
              pause_timeout_minutes: '[[[ return variables.pause_timeout_minutes ]]]'

          # Media Player 2
          - type: custom:button-card
            template: hemma_badge_media_player
            variables:
              enabled: '[[[ return variables.show_media_player_4 ]]]'
              entity: '[[[ return variables.media_player_4 ]]]'
              pause_timeout_minutes: '[[[ return variables.pause_timeout_minutes ]]]'

    motion_detection: |
      [[[
        return "Motion detected"
      ]]]
